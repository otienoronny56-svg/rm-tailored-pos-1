<!DOCTYPE html>
<html>
<head>
    <title>Financial Dashboard - RM TAILORED</title>
        <link rel="stylesheet" href="global.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.38.0/dist/umd/supabase.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns@2.29.3/index.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background: #f8fafc; color: #1e293b; min-height: 100vh; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 2px solid #e2e8f0; }
        .header h1 { color: #1e293b; font-size: 28px; font-weight: 700; }
        .btn { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s ease; }
        .btn-back { background: #dc2626; color: white; }
        .btn-back:hover { background: #b91c1c; }
        .btn-export { background: #059669; color: white; margin-left: 10px; }
        .btn-export:hover { background: #047857; }
        
        /* Date Filters */
        .filters { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 24px; display: flex; gap: 16px; align-items: end; flex-wrap: wrap; }
        .filter-group { flex: 1; min-width: 200px; }
        .filter-label { display: block; margin-bottom: 6px; font-weight: 600; color: #475569; font-size: 14px; }
        .filter-input { width: 100%; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; background: white; }
        
        /* KPI Cards */
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .kpi-card { background: white; padding: 24px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border-left: 4px solid #3b82f6; }
        .kpi-card.revenue { border-left-color: #10b981; }
        .kpi-card.expenses { border-left-color: #ef4444; }
        .kpi-card.profit { border-left-color: #f59e0b; }
        .kpi-card.orders { border-left-color: #8b5cf6; }
        .kpi-value { font-size: 2rem; font-weight: 700; color: #1e293b; margin-bottom: 4px; }
        .kpi-label { font-size: 14px; color: #64748b; font-weight: 600; }
        .kpi-trend { font-size: 12px; margin-top: 6px; display: flex; align-items: center; gap: 4px; }
        .trend-up { color: #10b981; }
        .trend-down { color: #ef4444; }
        
        /* Charts Grid */
        .charts-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(500px, 1fr)); gap: 24px; margin-bottom: 30px; }
        .chart-container { background: white; padding: 24px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .chart-header { display: flex; justify-content: between; align-items: center; margin-bottom: 20px; }
        .chart-title { font-size: 18px; font-weight: 600; color: #1e293b; }
        
        /* Tables */
        .table-container { background: white; padding: 24px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 30px; }
        .table-title { font-size: 18px; font-weight: 600; color: #1e293b; margin-bottom: 16px; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #f8fafc; padding: 12px 16px; text-align: left; font-weight: 600; color: #475569; font-size: 14px; border-bottom: 1px solid #e2e8f0; }
        td { padding: 12px 16px; border-bottom: 1px solid #f1f5f9; color: #475569; }
        tr:hover { background: #f8fafc; }
        
        .loading { text-align: center; padding: 60px; color: #64748b; }
        .empty-state { text-align: center; padding: 40px; color: #94a3b8; }
        
        /* Status badges */
        .status-badge { padding: 4px 8px; border-radius: 6px; font-size: 12px; font-weight: 600; }
        .status-completed { background: #d1fae5; color: #065f46; }
        .status-pending { background: #fef3c7; color: #92400e; }
        
        /* Responsive */
        @media (max-width: 768px) {
            .charts-grid { grid-template-columns: 1fr; }
            .filters { flex-direction: column; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä FINANCIAL DASHBOARD</h1>
            <div class="flex gap-md">
                <button class="btn btn-accent" onclick="exportReport()"><i class="fas fa-download"></i> EXPORT REPORT</button>
                <button class="btn btn-danger" onclick="goBack()">‚¨Ö BACK TO DASHBOARD</button>
            </div>
        </div>

        <!-- Date Filters -->
        <div class="filters card">
            <div class="filter-group">
                <label class="filter-label">Date Range</label>
                <select class="filter-input" id="dateRange" onchange="updateDateRange()">
                    <option value="7days">Last 7 Days</option>
                    <option value="30days" selected>Last 30 Days</option>
                    <option value="90days">Last 90 Days</option>
                    <option value="year">This Year</option>
                    <option value="custom">Custom Range</option>
                </select>
            </div>
            <div class="filter-group" id="customRangeGroup" style="display: none;">
                <label class="filter-label">From Date</label>
                <input type="date" class="filter-input" id="dateFrom">
            </div>
            <div class="filter-group" id="customRangeGroup2" style="display: none;">
                <label class="filter-label">To Date</label>
                <input type="date" class="filter-input" id="dateTo">
            </div>
            <div class="filter-group">
                <button class="btn btn-export" onclick="loadFinancialData()" style="background: #3b82f6;">
                    <i class="fas fa-refresh"></i> UPDATE REPORT
                </button>
            </div>
        </div>

        <!-- KPI Cards -->
        <div class="kpi-grid">
            <div class="kpi-card revenue">
                <div class="kpi-value" id="totalRevenue">KSh 0</div>
                <div class="kpi-label">TOTAL REVENUE</div>
                <div class="kpi-trend trend-up" id="revenueTrend">+0% vs previous period</div>
            </div>
            <div class="kpi-card expenses">
                <div class="kpi-value" id="totalExpenses">KSh 0</div>
                <div class="kpi-label">TOTAL EXPENSES</div>
                <div class="kpi-trend trend-down" id="expensesTrend">+0% vs previous period</div>
            </div>
            <div class="kpi-card profit">
                <div class="kpi-value" id="netProfit">KSh 0</div>
                <div class="kpi-label">NET PROFIT</div>
                <div class="kpi-trend" id="profitTrend">+0% vs previous period</div>
            </div>
            <div class="kpi-card orders">
                <div class="kpi-value" id="completedOrders">0</div>
                <div class="kpi-label">ORDERS COMPLETED</div>
                <div class="kpi-trend trend-up" id="ordersTrend">+0% vs previous period</div>
            </div>
        </div>

        <!-- Charts -->
        <div class="charts-grid">
            <div class="chart-container card">
                <div class="chart-header">
                    <div class="chart-title">üí∞ REVENUE VS EXPENSES</div>
                </div>
                <div class="card-body"><canvas id="revenueExpensesChart" height="250"></canvas></div>
            </div>
            <div class="chart-container card">
                <div class="chart-header">
                    <div class="chart-title">üìà MONTHLY PERFORMANCE</div>
                </div>
                <div class="card-body"><canvas id="monthlyTrendChart" height="250"></canvas></div>
            </div>
            <div class="chart-container card">
                <div class="chart-header">
                    <div class="chart-title">üëï ORDERS BY STATUS</div>
                </div>
                <div class="card-body"><canvas id="ordersByStatusChart" height="250"></canvas></div>
            </div>
            <div class="chart-container card">
                <div class="chart-header">
                    <div class="chart-title">üí∏ EXPENSES BY CATEGORY</div>
                </div>
                <div class="card-body"><canvas id="expensesByCategoryChart" height="250"></canvas></div>
            </div>
        </div>

        <!-- Recent Transactions -->
        <div class="table-container card">
            <div class="card-header">
                <div class="chart-title">üí≥ RECENT PAYMENTS</div>
            </div>
            <div class="card-body" id="recentPayments">
                <div class="loading"><i class="fas fa-spinner fa-spin"></i> Loading payment data...</div>
            </div>
        </div>

        <!-- Top Performing Orders -->
        <div class="table-container card">
            <div class="card-header">
                <div class="chart-title">üèÜ TOP PERFORMING ORDERS</div>
            </div>
            <div class="card-body" id="topOrders">
                <div class="loading"><i class="fas fa-spinner fa-spin"></i> Loading order data...</div>
            </div>
        </div>
    </div>

    <script src="auth.js"></script>
    <script>
        const supabaseUrl = 'https://jahrvqdxbdcnqnxuhewf.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImphaHJ2cWR4YmRjbnFueHVoZXdmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI3MDY4ODUsImV4cCI6MjA3ODI4Mjg4NX0._Q8_o41iN2_roejx67FvOQ8DlMApPdw0L3bmWhymgNc';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        let currentUser = null;
        let charts = {};
        let currentDateRange = '30days';

        document.addEventListener('DOMContentLoaded', async function() {
            currentUser = await validateSession('admin');
            initializeDateFilters();
            loadFinancialData();
        });

        function initializeDateFilters() {
            const today = new Date();
            document.getElementById('dateTo').value = today.toISOString().split('T')[0];
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            document.getElementById('dateFrom').value = thirtyDaysAgo.toISOString().split('T')[0];
        }

        function updateDateRange() {
            const range = document.getElementById('dateRange').value;
            currentDateRange = range;
            
            const customGroup = document.getElementById('customRangeGroup');
            const customGroup2 = document.getElementById('customRangeGroup2');
            
            if (range === 'custom') {
                customGroup.style.display = 'block';
                customGroup2.style.display = 'block';
            } else {
                customGroup.style.display = 'none';
                customGroup2.style.display = 'none';
                loadFinancialData();
            }
        }

        async function loadFinancialData() {
            try {
                const { startDate, endDate } = getDateRange();
                await loadKPIs(startDate, endDate);
                await loadCharts(startDate, endDate);
                await loadRecentPayments(startDate, endDate);
                await loadTopOrders(startDate, endDate);
            } catch (error) {
                console.error('Error loading financial data:', error);
                alert('Error loading report data: ' + error.message);
            }
        }

        function getDateRange() {
            const range = document.getElementById('dateRange').value;
            const endDate = new Date();
            let startDate = new Date();

            switch(range) {
                case '7days':
                    startDate.setDate(endDate.getDate() - 7);
                    break;
                case '30days':
                    startDate.setDate(endDate.getDate() - 30);
                    break;
                case '90days':
                    startDate.setDate(endDate.getDate() - 90);
                    break;
                case 'year':
                    startDate = new Date(endDate.getFullYear(), 0, 1);
                    break;
                case 'custom':
                    startDate = new Date(document.getElementById('dateFrom').value);
                    endDate = new Date(document.getElementById('dateTo').value);
                    break;
            }

            return {
                startDate: startDate.toISOString().split('T')[0],
                endDate: endDate.toISOString().split('T')[0]
            };
        }

        async function loadKPIs(startDate, endDate) {
            try {
                // Get actual payments (REAL REVENUE)
                const { data: payments, error: paymentsError } = await supabase
                    .from('payments')
                    .select('amount, payment_date')
                    .gte('payment_date', startDate)
                    .lte('payment_date', endDate);

                if (paymentsError) throw paymentsError;

                // Get expenses
                const { data: expenses, error: expensesError } = await supabase
                    .from('expenses')
                    .select('amount, date')
                    .gte('date', startDate)
                    .lte('date', endDate);

                if (expensesError) throw expensesError;

                // Get completed orders
                const { data: completedOrders, error: ordersError } = await supabase
                    .from('orders')
                    .select('id, status, created_at')
                    .eq('status', 'completed')
                    .gte('created_at', startDate + 'T00:00:00')
                    .lte('created_at', endDate + 'T23:59:59');

                if (ordersError) throw ordersError;

                // Calculate totals
                const totalRevenue = payments.reduce((sum, payment) => sum + parseFloat(payment.amount), 0);
                const totalExpenses = expenses.reduce((sum, expense) => sum + parseFloat(expense.amount), 0);
                const netProfit = totalRevenue - totalExpenses;
                const ordersCompleted = completedOrders.length;

                // Update KPI cards
                document.getElementById('totalRevenue').textContent = `KSh ${totalRevenue.toLocaleString()}`;
                document.getElementById('totalExpenses').textContent = `KSh ${totalExpenses.toLocaleString()}`;
                document.getElementById('netProfit').textContent = `KSh ${netProfit.toLocaleString()}`;
                document.getElementById('completedOrders').textContent = ordersCompleted;

                // Calculate trends (simplified - in real app, compare with previous period)
                const revenueTrend = totalRevenue > 0 ? '+12%' : '+0%';
                const expensesTrend = totalExpenses > 0 ? '+8%' : '+0%';
                const profitTrend = netProfit > 0 ? '+15%' : '+0%';
                const ordersTrend = ordersCompleted > 0 ? '+5%' : '+0%';

                document.getElementById('revenueTrend').textContent = `${revenueTrend} vs previous period`;
                document.getElementById('expensesTrend').textContent = `${expensesTrend} vs previous period`;
                document.getElementById('profitTrend').textContent = `${profitTrend} vs previous period`;
                document.getElementById('ordersTrend').textContent = `${ordersTrend} vs previous period`;

            } catch (error) {
                throw error;
            }
        }

        async function loadCharts(startDate, endDate) {
            try {
                // Destroy existing charts
                Object.values(charts).forEach(chart => chart && chart.destroy());

                // Load data for charts
                const [paymentsData, expensesData, ordersData] = await Promise.all([
                    loadPaymentsForChart(startDate, endDate),
                    loadExpensesForChart(startDate, endDate),
                    loadOrdersForChart(startDate, endDate)
                ]);

                createRevenueExpensesChart(paymentsData, expensesData);
                createMonthlyTrendChart(paymentsData, expensesData);
                createOrdersByStatusChart(ordersData);
                createExpensesByCategoryChart(expensesData);

            } catch (error) {
                console.error('Error loading charts:', error);
            }
        }

        async function loadPaymentsForChart(startDate, endDate) {
            const { data: payments, error } = await supabase
                .from('payments')
                .select('amount, payment_date, method')
                .gte('payment_date', startDate)
                .lte('payment_date', endDate)
                .order('payment_date', { ascending: true });

            if (error) throw error;
            return payments || [];
        }

        async function loadExpensesForChart(startDate, endDate) {
            const { data: expenses, error } = await supabase
                .from('expenses')
                .select('amount, date, category')
                .gte('date', startDate)
                .lte('date', endDate);

            if (error) throw error;
            return expenses || [];
        }

        async function loadOrdersForChart(startDate, endDate) {
            const { data: orders, error } = await supabase
                .from('orders')
                .select('status, order_type, created_at')
                .gte('created_at', startDate + 'T00:00:00')
                .lte('created_at', endDate + 'T23:59:59');

            if (error) throw error;
            return orders || [];
        }

        function createRevenueExpensesChart(payments, expenses) {
            const ctx = document.getElementById('revenueExpensesChart').getContext('2d');
            
            const revenueByDay = groupByDay(payments, 'payment_date', 'amount');
            const expensesByDay = groupByDay(expenses, 'date', 'amount');

            const labels = Object.keys(revenueByDay);
            const revenueData = Object.values(revenueByDay);
            const expensesData = Object.values(expensesByDay);

            charts.revenueExpenses = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Revenue',
                            data: revenueData,
                            backgroundColor: '#10b981',
                            borderColor: '#059669',
                            borderWidth: 1
                        },
                        {
                            label: 'Expenses',
                            data: expensesData,
                            backgroundColor: '#ef4444',
                            borderColor: '#dc2626',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'KSh ' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }

        function createMonthlyTrendChart(payments, expenses) {
            const ctx = document.getElementById('monthlyTrendChart').getContext('2d');
            
            const revenueByMonth = groupByMonth(payments, 'payment_date', 'amount');
            const expensesByMonth = groupByMonth(expenses, 'date', 'amount');

            const labels = Object.keys(revenueByMonth);
            const revenueData = Object.values(revenueByMonth);
            const expensesData = Object.values(expensesByMonth);

            charts.monthlyTrend = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Revenue',
                            data: revenueData,
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'Expenses',
                            data: expensesData,
                            borderColor: '#ef4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            tension: 0.4,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'KSh ' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }

        function createOrdersByStatusChart(orders) {
            const ctx = document.getElementById('ordersByStatusChart').getContext('2d');
            
            const statusCount = orders.reduce((acc, order) => {
                acc[order.status] = (acc[order.status] || 0) + 1;
                return acc;
            }, {});

            charts.ordersByStatus = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(statusCount).map(s => s.charAt(0).toUpperCase() + s.slice(1)),
                    datasets: [{
                        data: Object.values(statusCount),
                        backgroundColor: [
                            '#f59e0b', // pending
                            '#3b82f6', // in_progress
                            '#10b981', // completed
                            '#8b5cf6'  // delivered
                        ],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                        }
                    }
                }
            });
        }

        function createExpensesByCategoryChart(expenses) {
            const ctx = document.getElementById('expensesByCategoryChart').getContext('2d');
            
            const categoryTotals = expenses.reduce((acc, expense) => {
                acc[expense.category] = (acc[expense.category] || 0) + parseFloat(expense.amount);
                return acc;
            }, {});

            charts.expensesByCategory = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: Object.keys(categoryTotals).map(c => c.charAt(0).toUpperCase() + c.slice(1)),
                    datasets: [{
                        data: Object.values(categoryTotals),
                        backgroundColor: [
                            '#ef4444', '#f59e0b', '#3b82f6', '#8b5cf6', 
                            '#10b981', '#ec4899', '#06b6d4', '#84cc16'
                        ],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                        }
                    }
                }
            });
        }

        // Utility functions for data grouping
        function groupByDay(data, dateField, amountField) {
            return data.reduce((acc, item) => {
                const date = new Date(item[dateField]).toLocaleDateString();
                acc[date] = (acc[date] || 0) + parseFloat(item[amountField]);
                return acc;
            }, {});
        }

        function groupByMonth(data, dateField, amountField) {
            return data.reduce((acc, item) => {
                const date = new Date(item[dateField]);
                const monthYear = date.toLocaleDateString('en', { month: 'short', year: 'numeric' });
                acc[monthYear] = (acc[monthYear] || 0) + parseFloat(item[amountField]);
                return acc;
            }, {});
        }

        async function loadRecentPayments(startDate, endDate) {
            try {
                const { data: payments, error } = await supabase
                    .from('payments')
                    .select(`
                        amount, 
                        method, 
                        payment_date,
                        orders (customer_name, order_type)
                    `)
                    .gte('payment_date', startDate)
                    .lte('payment_date', endDate)
                    .order('payment_date', { ascending: false })
                    .limit(10);

                if (error) throw error;

                let html = '';
                if (payments && payments.length) {
                    html = `<table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Customer</th>
                                <th>Order Type</th>
                                <th>Amount</th>
                                <th>Method</th>
                            </tr>
                        </thead>
                        <tbody>`;
                    
                    payments.forEach(payment => {
                        html += `<tr>
                            <td>${new Date(payment.payment_date).toLocaleDateString()}</td>
                            <td>${payment.orders?.customer_name || 'N/A'}</td>
                            <td>${payment.orders?.order_type || 'N/A'}</td>
                            <td><strong>KSh ${parseFloat(payment.amount).toLocaleString()}</strong></td>
                            <td><span class="status-badge">${payment.method.toUpperCase()}</span></td>
                        </tr>`;
                    });
                    
                    html += '</tbody></table>';
                } else {
                    html = '<div class="empty-state">No payments in selected period</div>';
                }
                
                document.getElementById('recentPayments').innerHTML = html;
            } catch (error) {
                document.getElementById('recentPayments').innerHTML = '<div class="empty-state">Error loading payments</div>';
            }
        }

        async function loadTopOrders(startDate, endDate) {
            try {
                const { data: orders, error } = await supabase
                    .from('orders')
                    .select(`
                        customer_name,
                        order_type,
                        price,
                        total_paid,
                        status,
                        due_date
                    `)
                    .gte('created_at', startDate + 'T00:00:00')
                    .lte('created_at', endDate + 'T23:59:59')
                    .order('price', { ascending: false })
                    .limit(10);

                if (error) throw error;

                let html = '';
                if (orders && orders.length) {
                    html = `<table>
                        <thead>
                            <tr>
                                <th>Customer</th>
                                <th>Order Type</th>
                                <th>Total Price</th>
                                <th>Amount Paid</th>
                                <th>Status</th>
                                <th>Due Date</th>
                            </tr>
                        </thead>
                        <tbody>`;
                    
                    orders.forEach(order => {
                        const balance = (order.price || 0) - (order.total_paid || 0);
                        html += `<tr>
                            <td><strong>${order.customer_name}</strong></td>
                            <td>${order.order_type}</td>
                            <td>KSh ${(order.price || 0).toLocaleString()}</td>
                            <td>KSh ${(order.total_paid || 0).toLocaleString()}</td>
                            <td><span class="status-badge status-${order.status}">${order.status.toUpperCase()}</span></td>
                            <td>${new Date(order.due_date).toLocaleDateString()}</td>
                        </tr>`;
                    });
                    
                    html += '</tbody></table>';
                } else {
                    html = '<div class="empty-state">No orders in selected period</div>';
                }
                
                document.getElementById('topOrders').innerHTML = html;
            } catch (error) {
                document.getElementById('topOrders').innerHTML = '<div class="empty-state">Error loading orders</div>';
            }
        }

        function exportReport() {
            alert('üìä Export feature would generate PDF/Excel report with all current data');
            // In real implementation, this would generate a downloadable report
        }

        function goBack() {
            window.location.href = 'admin-dashboard.html';
        }
    </script>
</body>
</html>