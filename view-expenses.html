<!DOCTYPE html>
<html>
<head>
    <title>View Expenses - RM TAILORED</title>
    <link rel="stylesheet" href="global.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.38.0/dist/umd/supabase.min.js"></script>
    <script src="auth.js"></script>
    <style>
        body { font-family: sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; }
        h1 { color: #dc143c; text-align: center; margin-bottom: 30px; }
        .btn { background: #dc143c; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin: 5px; }
        .btn-success { background: #228B22; }
        .btn-back { background: #666; margin-top: 20px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background: #f8f8f8; }
        .total-section { background: #f9f9f9; padding: 15px; border-radius: 8px; margin: 20px 0; }
        .total-amount { font-size: 1.5em; font-weight: bold; color: #dc143c; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸ’° EXPENSE TRACKER</h1>
        
        <div style="text-align: center; margin-bottom: 20px;">
            <button class="btn btn-success" onclick="location.href='add-expense.html'">âž• ADD NEW EXPENSE</button>
        </div>

        <div class="total-section">
            <h3>ðŸ“Š Total Expenses: <span class="total-amount" id="totalAmount">KSh 0</span></h3>
        </div>

        <div id="expensesList">
            <p>Loading expenses...</p>
        </div>

        <button class="btn btn-back" onclick="goBack()">â¬… BACK TO DASHBOARD</button>
    </div>

    <script>
        // Initialize Supabase
        const supabaseUrl = 'https://jahrvqdxbdcnqnxuhewf.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImphaHJ2cWR4YmRjbnFueHVoZXdmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI3MDY4ODUsImV4cCI6MjA3ODI4Mjg4NX0._Q8_o41iN2_roejx67FvOQ8DlMApPdw0L3bmWhymgNc';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        // Validate session then load expenses
        document.addEventListener('DOMContentLoaded', async function() {
            await validateSession();
            loadExpenses();
        });

        async function loadExpenses() {
            try {
                // Get all expenses
                const { data: expenses, error } = await supabase
                    .from('expenses')
                    .select('*')
                    .order('date', { ascending: false });

                if (error) throw error;

                displayExpenses(expenses);
                updateTotalAmount(expenses);
                
            } catch (error) {
                document.getElementById('expensesList').innerHTML = '<p>Error loading expenses: ' + error.message + '</p>';
            }
        }

        function displayExpenses(expenses) {
            const container = document.getElementById('expensesList');
            
            if (!expenses || expenses.length === 0) {
                container.innerHTML = '<p>No expenses found. Add your first expense!</p>';
                return;
            }

            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Description</th>
                            <th>Category</th>
                            <th>Amount</th>
                            <th>Notes</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            expenses.forEach(expense => {
                const date = new Date(expense.date).toLocaleDateString();
                
                html += `
                    <tr>
                        <td>${date}</td>
                        <td>${expense.description}</td>
                        <td>${expense.category}</td>
                        <td><strong>KSh ${expense.amount}</strong></td>
                        <td>${expense.notes || '-'}</td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function updateTotalAmount(expenses) {
            const total = expenses.reduce((sum, expense) => {
                return sum + parseFloat(expense.amount);
            }, 0);

            document.getElementById('totalAmount').textContent = `KSh ${total.toFixed(2)}`;
        }

        function goBack() {
            window.location.href = 'admin-dashboard.html';
        }
    </script>
</body>
</html>